name: PR Preview Comment

on:
  workflow_run:
    workflows: ["PR Preview"]
    types:
      - completed

jobs:
  comment:
    runs-on: ubuntu-latest
    # workflow_run は完了を待つため、失敗した場合もコメントを投稿
    if: >
      (github.event.workflow_run.event == 'pull_request' ||
       github.event.workflow_run.event == 'pull_request_target') &&
      github.event.workflow_run.conclusion != 'cancelled'
    permissions:
      actions: read
      pull-requests: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Read PR number
        id: pr
        run: |
          set -euo pipefail

          # PR 番号ファイルのパスを定義
          PR_NUMBER_FILE="pr-number/pr_number.txt"

          # PR 番号ファイルの存在と中身をチェック
          if [ ! -s "$PR_NUMBER_FILE" ]; then
            echo "Error: PR number file '$PR_NUMBER_FILE' not found or is empty." >&2
            exit 1
          fi

          # PR 番号を読み取り
          PR_NUMBER="$(cat "$PR_NUMBER_FILE")"

          # PR 番号が空でないか確認
          if [ -z "$PR_NUMBER" ]; then
            echo "Error: PR number is empty." >&2
            exit 1
          fi

          # PR 番号が数値であることを確認
          if ! [[ "$PR_NUMBER" =~ ^[0-9]+$ ]]; then
            echo "Error: Invalid PR number '$PR_NUMBER'." >&2
            exit 1
          fi

          echo "number=$PR_NUMBER" >> "$GITHUB_OUTPUT"

      - name: Read results
        id: results
        run: |
          set -euo pipefail

          if [ -f pr-preview-results/summary.txt ]; then
            {
              echo 'summary<<EOF'
              cat pr-preview-results/summary.txt
              echo 'EOF'
            } >> "$GITHUB_OUTPUT"
          else
            {
              echo 'summary<<EOF'
              echo '## 結果の取得に失敗しました'
              echo ''
              echo 'dry-run の結果が artifact に保存されていません。'
              echo 'EOF'
            } >> "$GITHUB_OUTPUT"
          fi

          if [ -f pr-preview-results/details.txt ]; then
            {
              echo 'details<<EOF'
              cat pr-preview-results/details.txt
              echo 'EOF'
            } >> "$GITHUB_OUTPUT"
          else
            {
              echo 'details<<EOF'
              echo 'ログがありません。'
              echo 'EOF'
            } >> "$GITHUB_OUTPUT"
          fi

      - name: Find existing comment
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ steps.pr.outputs.number }}
          comment-author: 'github-actions[bot]'
          body-includes: '<!-- sync-repo-settings-preview -->'

      - name: Create or update comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ steps.pr.outputs.number }}
          edit-mode: replace
          body: |
            <!-- sync-repo-settings-preview -->
            # Dry-Run Preview

            この PR がマージされた場合に適用される設定の一覧です。

            ${{ steps.results.outputs.summary }}

            <details>
            <summary>詳細ログを表示</summary>

            ```
            ${{ steps.results.outputs.details }}
            ```

            </details>

            ---
            *このコメントは PR の変更に応じて自動更新されます。*
