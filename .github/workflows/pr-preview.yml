name: PR Preview

on:
  pull_request:
    branches:
      - master
    paths:
      - 'config.json'
      - 'apply-settings.sh'

jobs:
  preview:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run dry-run
        id: dry-run
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          chmod +x ./apply-settings.sh

          # dry-run を実行（stdout: Markdown サマリー、stderr: 詳細ログ）
          set +e
          ./apply-settings.sh --dry-run --markdown > summary.txt 2> details.txt
          exit_code=$?
          set -e

          # エラー時の処理
          if [ $exit_code -ne 0 ]; then
            echo "## エラーが発生しました" > summary.txt
            echo "" >> summary.txt
            echo "終了コード: $exit_code" >> summary.txt
          fi

          # サマリーを出力として設定
          {
            echo 'summary<<EOF'
            cat summary.txt
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

          # 詳細ログを出力として設定
          {
            echo 'details<<EOF'
            cat details.txt
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Find existing comment
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: '<!-- sync-repo-settings-preview -->'

      - name: Create or update comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body: |
            <!-- sync-repo-settings-preview -->
            # Dry-Run Preview

            この PR がマージされた場合に適用される設定の一覧です。

            ${{ steps.dry-run.outputs.summary }}

            <details>
            <summary>詳細ログを表示</summary>

            ```
            ${{ steps.dry-run.outputs.details }}
            ```

            </details>

            ---
            *このコメントは PR の変更に応じて自動更新されます。*
