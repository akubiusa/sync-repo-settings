name: PR Preview

on:
  pull_request_target:
    branches:
      - master

jobs:
  preview:
    runs-on: ubuntu-latest
    # pull_request_target（フォーク）の場合は Environment で承認が必要
    environment: ${{ github.event_name == 'pull_request_target' && 'pr-preview' || null }}
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Post approval request comment
        if: github.event_name == 'pull_request_target'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## Environment 承認待ち

            この PR の dry-run を実行するには、Environment `pr-preview` の承認が必要です。

            [Actions run を確認して承認してください](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}?pr=${{ github.event.pull_request.number }})

      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          # pull_request_target の場合は PR の HEAD をチェックアウト
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || github.ref }}

      - name: Run dry-run
        id: dry-run
        continue-on-error: true
        env:
          # 注意: GITHUB_TOKEN は単一リポジトリにしかアクセスできないため、
          # 複数リポジトリの設定を読み取る apply-settings.sh では使用できない
          # PERSONAL_ACCESS_TOKEN を使用する必要がある
          # ただし、フォークからの PR では PERSONAL_ACCESS_TOKEN にアクセスできないため、
          # エラーメッセージを表示して終了する
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          chmod +x ./apply-settings.sh

          # PAT が空の場合のエラー（通常は発生しない）
          if [ -z "$GH_TOKEN" ]; then
            echo "## PERSONAL_ACCESS_TOKEN が設定されていません" > summary.txt
            echo "" >> summary.txt
            echo "Repository Secrets に PERSONAL_ACCESS_TOKEN を設定してください。" >> summary.txt
            echo "" > details.txt
            exit 1
          fi

          # dry-run を実行（stdout: Markdown サマリー、stderr: 詳細ログ）
          set +e +o pipefail
          ./apply-settings.sh --dry-run --markdown > summary.txt 2> details.txt
          exit_code=$?
          set -eo pipefail

          # エラー時の処理
          if [ $exit_code -ne 0 ]; then
            echo "## エラーが発生しました" > summary.txt
            echo "" >> summary.txt
            echo "終了コード: $exit_code" >> summary.txt
          fi

      - name: Ensure result files exist
        if: always()
        run: |
          touch summary.txt details.txt

      - name: Upload results as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pr-preview-results
          path: |
            summary.txt
            details.txt
          retention-days: 1

      - name: Save PR number
        if: always()
        run: echo ${{ github.event.pull_request.number }} > pr_number.txt

      - name: Upload PR number
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pr-number
          path: pr_number.txt
          retention-days: 1
