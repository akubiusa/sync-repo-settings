name: PR Preview

on:
  pull_request:
    branches:
      - master
    paths:
      - 'config.json'
      - 'apply-settings.sh'
  pull_request_target:
    branches:
      - master
    paths:
      - 'config.json'
      - 'apply-settings.sh'

jobs:
  preview:
    runs-on: ubuntu-latest
    # pull_request_target（フォーク）の場合は Environment で承認が必要
    environment: ${{ github.event_name == 'pull_request_target' && 'pr-preview' || null }}
    permissions:
      contents: read
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          # pull_request_target の場合は PR の HEAD をチェックアウト
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || github.ref }}

      - name: Run dry-run
        id: dry-run
        continue-on-error: true
        env:
          # 注意: GITHUB_TOKEN は単一リポジトリにしかアクセスできないため、
          # 複数リポジトリの設定を読み取る apply-settings.sh では使用できない
          # PERSONAL_ACCESS_TOKEN を使用する必要がある
          # ただし、フォークからの PR では PERSONAL_ACCESS_TOKEN にアクセスできないため、
          # エラーメッセージを表示して終了する
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          chmod +x ./apply-settings.sh

          # PAT が空の場合のエラーハンドリング
          if [ -z "$GH_TOKEN" ]; then
            if [ "$GITHUB_EVENT_NAME" = "pull_request_target" ]; then
              # フォークからの PR の場合
              echo "## フォークからの PR では dry-run を実行できません" > summary.txt
              echo "" >> summary.txt
              echo "セキュリティ上の理由から、フォークからの PR では他のリポジトリの情報にアクセスできません。" >> summary.txt
              echo "" >> summary.txt
              echo "### 実行する方法" >> summary.txt
              echo "" >> summary.txt
              echo "write 権限を持つコラボレーターが以下の手順で実行を承認できます：" >> summary.txt
              echo "" >> summary.txt
              echo "1. GitHub Actions の [Workflows](https://github.com/$GITHUB_REPOSITORY/actions/workflows/pr-preview.yml) を開く" >> summary.txt
              echo "2. 実行待ちのワークフローを確認" >> summary.txt
              echo "3. PR のコード内容を確認した上で、「Review deployments」をクリックして承認" >> summary.txt
              echo "" >> summary.txt
              echo "**注意**: 承認すると、PR のコード（apply-settings.sh を含む）が実行されます。" >> summary.txt
            else
              # 同一リポジトリからの PR の場合
              echo "## PERSONAL_ACCESS_TOKEN が設定されていません" > summary.txt
              echo "" >> summary.txt
              echo "dry-run を実行するには、Repository Secrets に PERSONAL_ACCESS_TOKEN を設定してください。" >> summary.txt
            fi
            echo "" > details.txt
            exit 0
          fi

          # dry-run を実行（stdout: Markdown サマリー、stderr: 詳細ログ）
          set +e +o pipefail
          ./apply-settings.sh --dry-run --markdown > summary.txt 2> details.txt
          exit_code=$?
          set -eo pipefail

          # エラー時の処理
          if [ $exit_code -ne 0 ]; then
            echo "## エラーが発生しました" > summary.txt
            echo "" >> summary.txt
            echo "終了コード: $exit_code" >> summary.txt
          fi

      - name: Ensure result files exist
        if: always()
        run: |
          touch summary.txt details.txt

      - name: Upload results as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pr-preview-results
          path: |
            summary.txt
            details.txt
          retention-days: 1

      - name: Save PR number
        if: always()
        run: echo ${{ github.event.pull_request.number }} > pr_number.txt

      - name: Upload PR number
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pr-number
          path: pr_number.txt
          retention-days: 1
