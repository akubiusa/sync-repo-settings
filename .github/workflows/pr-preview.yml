name: PR Preview

on:
  pull_request:
    branches:
      - master
    paths:
      - 'config.json'
      - 'apply-settings.sh'

jobs:
  preview:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run dry-run
        id: dry-run
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          chmod +x ./apply-settings.sh

          # dry-run を実行し、Markdown 出力を取得
          set +e
          output=$(./apply-settings.sh --dry-run --markdown 2>&1)
          exit_code=$?
          set -e

          # 出力をファイルに保存（複数行対応）
          if [ $exit_code -ne 0 ]; then
            echo "## エラーが発生しました" > dry-run-output.txt
            echo "" >> dry-run-output.txt
            echo "終了コード: $exit_code" >> dry-run-output.txt
            echo "" >> dry-run-output.txt
            echo '```' >> dry-run-output.txt
            echo "$output" >> dry-run-output.txt
            echo '```' >> dry-run-output.txt
          else
            echo "$output" > dry-run-output.txt
          fi

          # GitHub Actions の出力として設定
          {
            echo 'preview<<EOF'
            cat dry-run-output.txt
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Find existing comment
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: '<!-- sync-repo-settings-preview -->'

      - name: Create or update comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body: |
            <!-- sync-repo-settings-preview -->
            # Dry-Run Preview

            この PR がマージされた場合に適用される設定の一覧です。

            <details>
            <summary>詳細を表示</summary>

            ${{ steps.dry-run.outputs.preview }}

            </details>

            ---
            *このコメントは PR の変更に応じて自動更新されます。*
